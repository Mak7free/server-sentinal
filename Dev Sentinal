{
  "project": {
    "name": "DevSentinel LMS",
    "tagline": "Hybrid Developer Management Platform: LMS + Project Management + AI Agent Supervision",
    "architecture": "Modular Monolith (Django Core + FastAPI Sidecar)",
    "design_language": "Minimal Modern, Data-Dense, IBM Lean Aesthetics"
  },
  
  "role_context": {
    "persona": "You are a Principal Software Architect with 15+ years building secure, scalable SaaS platforms",
    "mandate": "Generate production-grade, battle-tested code - NOT prototypes or placeholders",
    "quality_bar": "Each component must be deployment-ready with proper error handling, logging, and security hardening"
  },

  "tech_stack": {
    "backend_primary": {
      "core": "Django 5.0 + Django REST Framework",
      "responsibilities": ["Authentication", "Database ORM", "Admin Panel", "Synchronous CRUD"],
      "security": {
        "password_hashing": "Argon2 via django-argon2 (memory_cost=102400, time_cost=2, parallelism=8)",
        "authentication": "JWT in HttpOnly cookies via djangorestframework-simplejwt",
        "csrf": "Django CSRF with double-submit cookie pattern",
        "cors": "django-cors-headers with strict allowlist (no wildcards)",
        "headers": "django-csp + SecurityMiddleware (HSTS, X-Frame-Options, Content-Type-Options)"
      },
      "additional_packages": ["celery[redis]", "django-extensions", "django-filter", "drf-spectacular"]
    },
    
    "backend_secondary": {
      "core": "FastAPI 0.109+",
      "responsibilities": ["Async webhook ingestion", "AI agent streams", "WebSocket real-time updates"],
      "integration": "Share PostgreSQL with Django, mount at /api/v1/async",
      "security": ["HMAC signature verification", "Rate limiting via slowapi", "Input validation via Pydantic V2"]
    },
    
    "frontend": {
      "core": "React 18 + TypeScript 5.3 + Vite 5",
      "state_management": {
        "global": "Zustand 4.x (auth, user preferences, theme)",
        "server": "TanStack Query v5 (cache, mutations, optimistic updates)",
        "form": "React Hook Form + Zod validation"
      },
      "ui_framework": "shadcn/ui (Radix Primitives) + TailwindCSS 3.4",
      "drag_drop": "dnd-kit (Kanban boards, module reordering)",
      "charts": "Recharts (skill analytics, performance dashboards)",
      "code_editor": "Monaco Editor (for coding challenges)",
      "additional": ["Sonner (toast notifications)", "cmdk (command palette)", "date-fns"]
    },
    
    "data_layer": {
      "primary_db": "PostgreSQL 16 with pgvector extension",
      "caching": "Redis 7.x (Celery broker, session cache, rate limiting)",
      "search": "PostgreSQL Full-Text Search (upgrade to Meilisearch later)",
      "file_storage": "S3-compatible (MinIO for dev, AWS S3 for prod)"
    },
    
    "ai_orchestration": {
      "framework": "LangChain 0.1.x + LangGraph",
      "models": "OpenAI GPT-4 (primary), Anthropic Claude (fallback)",
      "vector_store": "pgvector for skill/content embeddings",
      "agent_pattern": "Stateful Supervisor with human-in-the-loop checkpoints"
    },
    
    "infrastructure": {
      "containerization": "Docker + Docker Compose (dev), Kubernetes (prod)",
      "task_queue": "Celery with Redis broker",
      "monitoring": "Prometheus + Grafana (metrics), Sentry (errors)",
      "ci_cd": "GitHub Actions with pytest/Vitest coverage gates"
    }
  },

  "database_schema": {
    "users": {
      "model": "CustomUser(AbstractUser)",
      "fields": {
        "role": "CharField(choices=['ADMIN', 'MANAGER', 'DEVELOPER'])",
        "skill_vector": "ArrayField(FloatField) - 1536 dims for OpenAI embeddings",
        "current_skill_level": "IntegerField(1-10)",
        "last_assessment_date": "DateTimeField",
        "github_username": "CharField(unique, nullable)",
        "timezone": "CharField(default='UTC')",
        "onboarding_completed": "BooleanField(default=False)"
      },
      "indexes": ["role", "skill_vector (using ivfflat)"],
      "meta": "permissions = [('can_assign_tickets', 'Can assign tickets')]"
    },
    
    "tickets": {
      "model": "Ticket",
      "fields": {
        "title": "CharField(max_length=255)",
        "description": "TextField",
        "status": "CharField(choices=['TODO', 'IN_PROGRESS', 'REVIEW', 'DONE', 'BLOCKED'])",
        "priority": "CharField(choices=['LOW', 'MEDIUM', 'HIGH', 'URGENT'])",
        "complexity_score": "IntegerField(validators=[MinValueValidator(1), MaxValueValidator(10)])",
        "estimated_hours": "DecimalField(max_digits=5, decimal_places=2)",
        "actual_hours": "DecimalField(null=True)",
        "assigned_to": "ForeignKey(User, null=True, related_name='assigned_tickets')",
        "created_by": "ForeignKey(User, related_name='created_tickets')",
        "tech_stack_tags": "JSONField(default=list) - ['Python', 'React', 'PostgreSQL']",
        "required_skills": "JSONField(default=list) - skill slugs required",
        "ai_summary": "TextField(null=True) - LLM-generated ticket summary",
        "external_id": "CharField(unique, null=True) - Jira/GitHub ID",
        "due_date": "DateTimeField(null=True)",
        "blocked_reason": "TextField(null=True)"
      },
      "indexes": ["status", "assigned_to", "priority", "created_at"],
      "meta": "ordering = ['-priority', '-created_at']"
    },
    
    "learning_paths": {
      "model": "LearningPath",
      "fields": {
        "title": "CharField(max_length=255)",
        "description": "TextField",
        "target_role": "CharField(choices=['JUNIOR', 'MID', 'SENIOR', 'LEAD'])",
        "estimated_hours": "IntegerField",
        "prerequisites": "ManyToManyField('self', blank=True)",
        "is_mandatory": "BooleanField(default=False)",
        "difficulty_level": "IntegerField(1-5)",
        "created_by": "ForeignKey(User)"
      }
    },
    
    "modules": {
      "model": "Module",
      "fields": {
        "learning_path": "ForeignKey(LearningPath, related_name='modules')",
        "title": "CharField(max_length=255)",
        "content_type": "CharField(choices=['VIDEO', 'ARTICLE', 'QUIZ', 'CODING_CHALLENGE', 'PROJECT'])",
        "content_url": "URLField(null=True)",
        "content_markdown": "TextField(null=True)",
        "order": "IntegerField",
        "estimated_minutes": "IntegerField",
        "passing_score": "IntegerField(default=70) - for quizzes",
        "skills_taught": "JSONField(default=list)"
      },
      "meta": "ordering = ['learning_path', 'order']"
    },
    
    "user_progress": {
      "model": "UserProgress",
      "fields": {
        "user": "ForeignKey(User)",
        "module": "ForeignKey(Module)",
        "status": "CharField(choices=['NOT_STARTED', 'IN_PROGRESS', 'COMPLETED', 'FAILED'])",
        "time_spent_minutes": "IntegerField(default=0)",
        "score": "IntegerField(null=True) - for quizzes/challenges",
        "attempts": "IntegerField(default=0)",
        "completed_at": "DateTimeField(null=True)",
        "notes": "TextField(blank=True)"
      },
      "unique_together": ["user", "module"]
    },
    
    "audit_logs": {
      "model": "AuditLog",
      "fields": {
        "user": "ForeignKey(User, null=True, on_delete=SET_NULL)",
        "action": "CharField(choices=['CREATE', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT'])",
        "model_name": "CharField",
        "object_id": "IntegerField",
        "changes": "JSONField - old_value/new_value dict",
        "ip_address": "GenericIPAddressField",
        "user_agent": "TextField",
        "timestamp": "DateTimeField(auto_now_add=True)"
      },
      "meta": "ordering = ['-timestamp'], permissions = [('view_audit_log', 'Can view audit logs')]"
    },
    
    "ai_agent_sessions": {
      "model": "AgentSession",
      "fields": {
        "session_id": "UUIDField(primary_key=True)",
        "user": "ForeignKey(User)",
        "agent_type": "CharField(choices=['SKILL_ANALYZER', 'TICKET_ASSIGNER', 'CODE_REVIEWER'])",
        "state": "JSONField - LangGraph state snapshot",
        "status": "CharField(choices=['ACTIVE', 'PAUSED', 'COMPLETED', 'FAILED'])",
        "started_at": "DateTimeField(auto_now_add=True)",
        "completed_at": "DateTimeField(null=True)",
        "cost_usd": "DecimalField(max_digits=10, decimal_places=4)"
      }
    }
  },

  "critical_features": [
    {
      "id": "AUTH_01",
      "name": "Fort Knox Authentication System",
      "priority": "P0 - BLOCKING",
      "requirements": [
        "Configure Argon2 in settings.py with memory_cost=102400 (100MB), time_cost=2, parallelism=8",
        "Implement POST /auth/login endpoint returning JWT in httpOnly cookie (SameSite=Strict, Secure=True)",
        "Add CSRF token rotation on login/logout",
        "Implement refresh token rotation with family tracking to detect token theft",
        "Add rate limiting: 5 failed attempts = 15min lockout",
        "Log all auth events to AuditLog model",
        "Implement POST /auth/logout that blacklists refresh tokens in Redis",
        "Add middleware to validate JWT signature and check blacklist on every request"
      ],
      "tests": [
        "test_argon2_hashing_parameters",
        "test_login_sets_httponly_cookie",
        "test_login_rate_limiting",
        "test_refresh_token_rotation",
        "test_logout_blacklists_token",
        "test_csrf_token_validation"
      ]
    },
    
    {
      "id": "WEBHOOK_01",
      "name": "Intelligent Webhook Ingestion Pipeline",
      "priority": "P0 - BLOCKING",
      "requirements": [
        "FastAPI endpoint: POST /webhooks/incoming/{provider}",
        "Verify HMAC-SHA256 signature using provider-specific secret from env",
        "Parse payload using Pydantic models for Jira, GitHub, GitLab",
        "Use LangChain with GPT-4 to: (1) Summarize ticket, (2) Extract required skills, (3) Estimate complexity",
        "Save as generic Ticket model with external_id mapping",
        "Emit WebSocket event to /ws/tickets for real-time UI updates",
        "Store raw webhook payload in S3 for audit trail",
        "Return 200 OK within 500ms (async processing via Celery if needed)",
        "Add Prometheus metrics: webhook_ingestion_duration_seconds{provider}"
      ],
      "implementation_notes": [
        "Use LangChain's StructuredOutputParser to force JSON response from LLM",
        "Cache skill extraction results in Redis for 24h (key: webhook:{external_id}:skills)",
        "If LLM call fails, fallback to regex-based skill extraction from description",
        "Add exponential backoff retry for LLM calls (max 3 attempts)"
      ],
      "tests": [
        "test_webhook_signature_verification_success",
        "test_webhook_signature_verification_failure_returns_403",
        "test_jira_payload_parsing",
        "test_github_payload_parsing",
        "test_llm_skill_extraction_mocked",
        "test_ticket_created_in_database",
        "test_websocket_event_emitted"
      ]
    },
    
    {
      "id": "LMS_01",
      "name": "AI-Powered Skill Gap Analysis Agent",
      "priority": "P1 - HIGH",
      "requirements": [
        "Celery task: analyze_dev_performance(user_id) - runs weekly via beat scheduler",
        "Calculate 'performance_score' = avg(complexity_score / actual_hours) for last 30 days",
        "Fetch user's quiz scores from UserProgress where content_type='QUIZ'",
        "Use LangGraph ReAct agent to: (1) Identify skill gaps, (2) Recommend modules, (3) Flag for refresher if score dropped >20%",
        "If flagged, create UserProgress entries with status='NOT_STARTED' for recommended modules",
        "Send in-app notification + email using Django signals",
        "Store analysis results in AgentSession model for audit trail",
        "Add dashboard chart showing performance_score trend over time"
      ],
      "agent_architecture": {
        "graph_nodes": ["retrieve_tickets", "retrieve_quiz_scores", "calculate_metrics", "analyze_gaps", "recommend_modules"],
        "tools": ["TicketRetrieverTool", "QuizScoreRetrieverTool", "ModuleSearchTool"],
        "checkpoints": "Save after 'analyze_gaps' node for human review before auto-enrollment"
      },
      "tests": [
        "test_performance_score_calculation",
        "test_skill_gap_detection",
        "test_module_recommendation_logic",
        "test_notification_sent_on_flag",
        "test_agent_session_created"
      ]
    },
    
    {
      "id": "KANBAN_01",
      "name": "Drag-and-Drop Kanban with Optimistic UI",
      "priority": "P1 - HIGH",
      "requirements": [
        "React component using @dnd-kit/core and @dnd-kit/sortable",
        "Columns: TODO, IN_PROGRESS, REVIEW, DONE (configurable via API)",
        "Card shows: title, assignee avatar, complexity badge, tech tags",
        "On drop: (1) Immediately update Zustand store, (2) Show loading spinner on card, (3) Call PATCH /tickets/{id}",
        "Implement TanStack Query onMutate for optimistic update, onError for rollback",
        "Add drag overlay with card preview (CardOverlay component)",
        "Show 'Undo' toast for 5 seconds after successful move",
        "Add keyboard navigation: Arrow keys to move focus, Enter to select, Space to drag",
        "Virtual scrolling for columns with >50 cards (react-window)",
        "Add filters: Assigned to me, By priority, By tech stack"
      ],
      "state_management": {
        "zustand_store": "kanbanStore - tracks column order, card positions, drag state",
        "tanstack_query": "useTickets() hook with staleTime=30s, refetchOnWindowFocus=true"
      },
      "tests": [
        "test_kanban_renders_correct_columns",
        "test_card_moves_on_drop",
        "test_optimistic_update_applied",
        "test_rollback_on_api_error",
        "test_undo_functionality",
        "test_keyboard_navigation"
      ]
    },
    
    {
      "id": "DASHBOARD_01",
      "name": "Real-Time Analytics Dashboard",
      "priority": "P2 - MEDIUM",
      "requirements": [
        "Grid layout with draggable/resizable widgets (react-grid-layout)",
        "Widget types: Velocity chart, Burndown, Skill heatmap, Top performers, Upcoming deadlines",
        "Use Recharts for visualizations with custom tooltips",
        "Fetch data via TanStack Query with 2min staleTime",
        "Add date range picker (last 7/30/90 days or custom)",
        "Export dashboard as PDF (react-to-print)",
        "Save layout preferences to backend (POST /users/me/dashboard-layout)",
        "Add WebSocket subscription to /ws/metrics for live updates"
      ]
    }
  ],

  "testing_strategy": {
    "backend": {
      "framework": "pytest-django + pytest-asyncio",
      "coverage_target": "85% overall, 95% for auth/security code",
      "fixtures": [
        "factories using factory_boy for User, Ticket, Module",
        "mock_llm_response fixture to avoid OpenAI calls",
        "mock_webhook_signature fixture",
        "authenticated_client fixture with JWT setup"
      ],
      "test_categories": [
        "test_models.py - field validations, custom methods",
        "test_api_views.py - CRUD operations, permissions",
        "test_auth.py - login, logout, token refresh",
        "test_webhooks.py - signature verification, parsing",
        "test_tasks.py - Celery task logic",
        "test_permissions.py - role-based access control"
      ]
    },
    
    "frontend": {
      "framework": "Vitest + React Testing Library + MSW",
      "coverage_target": "80% overall",
      "setup": [
        "Mock API handlers with MSW (Mock Service Worker)",
        "Custom render function with QueryClientProvider + Zustand setup",
        "Mock dnd-kit with vitest.mock()"
      ],
      "test_categories": [
        "components/*.test.tsx - rendering, user interactions",
        "hooks/*.test.ts - custom hooks in isolation",
        "stores/*.test.ts - Zustand store logic",
        "integration/*.test.tsx - multi-component flows"
      ]
    }
  },

  "security_checklist": [
    "✓ Argon2 password hashing with production parameters",
    "✓ JWT in httpOnly cookies with SameSite=Strict",
    "✓ CSRF protection with double-submit pattern",
    "✓ CORS with strict origin allowlist (no wildcards)",
    "✓ Rate limiting on auth endpoints (5 req/min)",
    "✓ Input validation using Pydantic/DRF serializers",
    "✓ SQL injection prevention via ORM (no raw queries)",
    "✓ XSS prevention via CSP headers",
    "✓ HMAC signature verification for webhooks",
    "✓ Secrets in environment variables (never hardcoded)",
    "✓ TLS 1.3 only in production",
    "✓ Security headers (HSTS, X-Frame-Options, etc.)",
    "✓ Audit logging for sensitive operations",
    "✓ Principle of least privilege for DB roles"
  ],

  "output_format": {
    "structure": [
      "1. docker-compose.yml (Postgres, Redis, Django, FastAPI, React dev server)",
      "2. backend/settings/base.py (Django settings with inline comments)",
      "3. backend/models.py (All models with docstrings)",
      "4. backend/serializers.py (DRF serializers)",
      "5. backend/views.py (DRF ViewSets)",
      "6. backend/tasks.py (Celery tasks)",
      "7. fastapi_app/main.py (FastAPI routes)",
      "8. fastapi_app/webhooks.py (Webhook handlers)",
      "9. frontend/src/stores/authStore.ts (Zustand auth store)",
      "10. frontend/src/components/KanbanBoard.tsx (Drag-drop Kanban)",
      "11. frontend/src/hooks/useTickets.ts (TanStack Query hook)",
      "12. tests/test_webhooks.py (Backend tests with mocked LLM)",
      "13. frontend/src/components/KanbanBoard.test.tsx (Frontend tests)"
    ],
    "code_style": {
      "backend": "Black formatter, isort, flake8, type hints everywhere",
      "frontend": "Prettier, ESLint (Airbnb config), strict TypeScript"
    },
    "comments": [
      "Explain WHY security parameters were chosen (e.g., Argon2 memory_cost)",
      "Document any non-obvious business logic",
      "Add TODO comments for P2 features to implement later",
      "Link to relevant docs (Django, React, LangChain) in comments"
    ]
  },

  "deployment_checklist": [
    "Environment variables documented in .env.example",
    "Database migrations tested in staging",
    "Celery beat schedule configured",
    "Redis persistence enabled (AOF + RDB)",
    "Nginx reverse proxy config for Django + FastAPI",
    "Health check endpoints: /health (Django), /api/v1/async/health (FastAPI)",
    "Prometheus metrics exposed at /metrics",
    "Sentry SDK initialized with environment tag",
    "Database backups automated (daily full, hourly incremental)",
    "SSL certificates auto-renewed (Let's Encrypt + cert-bot)"
  ],

  "success_criteria": {
    "code_quality": "All tests pass, 85%+ coverage, no linting errors",
    "security": "OWASP Top 10 mitigations in place, security headers validated",
    "performance": "API response time <200ms p95, webhook processing <500ms",
    "documentation": "README with setup instructions, API docs via drf-spectacular",
    "developer_experience": "One command to spin up dev environment (docker-compose up)"
  }
}
